apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: image-updater
spec:
  params:
    - description: 'The ADO organization name'
      name: org
      type: string
    - description: 'The ADO project name'
      name: project
      type: string
    - description: Path within the source-repo to update
      name: file-path
      type: string
    - description: Name of the git repo that is being updated
      name: repo
      type: string
    - description: 'Image URL to populate file with e.g. myorg/my-image:c2b4eff'
      name: new-image-url
      type: string
    - default: main
      description: Branch to fetch for updating
      name: source-branch
      type: string
    - description: >
        Prefix for naming automatically generated branch, if empty, this will
        update source-branch
      name: branch-generate-name
      type: string
    - description: >
        JSON path within the file-path to update e.g.
        spec.template.spec.containers.0.image
      name: update-key
      type: string
  steps:
    - script: |
        update -o $(params.org) -j $(params.project) -f $(params.file-path) -s $(params.branch-generate-name) \
        -b $(params.source-branch) -i $(params.new-image-url) -r $(params.repo)
      env:
        - name: AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: image-updater-secret
      image: 'quay.io/mrethers/ado-image-updater:latest'
      name: update-image
      resources: {}
